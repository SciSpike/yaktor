#!/usr/bin/env bash

if [ ! -f ~/.npmrc ]; then
  touch ~/.npmrc
fi


if [ -z "$APP_NAME" ]; then
  APP_NAME=${PWD##*/}
  export APP_NAME=${APP_NAME//-} # (basename of the current directory)
fi

. $(dirname $0)/yak-up -d

export YAKTOR_DOCKER_MACHINE=${YAKTOR_DOCKER_MACHINE-default}

if [ "$(uname)" == "Darwin" ]; then
  if ! ./osx-route.sh 2> osx-route.log ; then
    cat osx-route.log
  fi
fi

if [ "$#" -eq 0 ]; then
  CMD=help
else
  CMD="$@"
fi

if [[ ! "$CMD" =~ ^(bash|yaktor|npm|node) ]]; then
  CMD="grunt $CMD"
elif [ "$CMD" == 'bash' ]; then
  CMD="bash -l"
fi

if [ "${INDEX:-1}" -gt "1" ]; then
  docker-compose scale app=${INDEX:-1}
fi
docker-compose exec --index ${INDEX-1} app bash -c ". ~/.profile && $CMD"
