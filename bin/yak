#!/usr/bin/env bash

if [ ! -f ~/.npmrc ]; then
  touch ~/.npmrc
fi

if [ "$(uname)" == "Darwin" ] && [ -n $(which docker-machine) ]; then
  docker-machine start default
  eval $(docker-machine env default)
fi

if [ -z "$APP_NAME" ]; then
  export APP_NAME=${PWD##*/} # (basename of the current directory)
fi

if grep -q APP_NAME_UPPERCASE ./docker-compose.yaml; then
  APP_NAME_UPPERCASE=$(echo -n $APP_NAME | awk '{print toupper($1)}')
  sed -i .previous -E "s/APP_NAME_UPPERCASE/$APP_NAME_UPPERCASE/g" ./docker-compose.yaml
fi

. $(dirname $0)/yak-up

if [ "$#" -eq 0 ]; then
  CMD=bash
else
  CMD="$@"
fi

# make sure things are configurable via environment variables
if [ ! -f ./config/custom-environment-variables.json ]; then
  docker exec -it ${APP_NAME}-app bash -c "npm run envars-default && $CMD"
else
  docker exec -it ${APP_NAME}-app $CMD
fi
